<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mux Netstate - Internet Checker</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjNWU3YmZkIiBkPSJNMTMuMTA2IDIyaC0yLjIxMmMtMy40NDcgMC01LjE3IDAtNi4zNDUtMS4wMTJzLTEuNDE5LTIuNzA1LTEuOTA2LTYuMDkzbC0uMjc5LTEuOTM3Yy0uMzgtMi42MzctLjU3LTMuOTU2LS4wMjktNS4wODNzMS42OTEtMS44MTMgMy45OTItMy4xODNsMS4zODUtLjgyNUM5LjggMi42MjIgMTAuODQ2IDIgMTIgMnMyLjE5OS42MjIgNC4yODggMS44NjdsMS4zODUuODI1YzIuMyAxLjM3IDMuNDUxIDIuMDU2IDMuOTkyIDMuMTgzcy4zNSAyLjQ0Ni0uMDMgNS4wODNsLS4yNzggMS45MzdjLS40ODcgMy4zODgtLjczMSA1LjA4MS0xLjkwNiA2LjA5M1MxNi41NTMgMjIgMTMuMTA2IDIyIiBvcGFjaXR5PSIwLjUiLz48cGF0aCBmaWxsPSIjNWU3YmZkIiBkPSJNMTcuNDUgMTIuMTkyYy0zLjAxNy0zLjI1Ni03Ljg4My0zLjI1Ni0xMC45IDBhLjc1Ljc1IDAgMSAxLTEuMS0xLjAyYzMuNjEtMy44OTYgOS40OS0zLjg5NiAxMy4xIDBhLjc1Ljc1IDAgMSAxLTEuMSAxLjAyIi8+PHBhdGggZmlsbD0iIzVlN2JmZCIgZD0iTTE1LjQ1IDE0LjM1Yy0xLjkxMi0yLjA2My00Ljk4Ny0yLjA2My02LjkgMGEuNzUuNzUgMCAxIDEtMS4xLTEuMDE5YzIuNTA2LTIuNzA0IDYuNTk0LTIuNzA0IDkuMSAwYS43NS43NSAwIDAgMS0xLjEgMS4wMiIvPjxwYXRoIGZpbGw9IiM1ZTdiZmQiIGQ9Ik0xMy40NSAxNi41MWMtLjgwOC0uODcyLTIuMDkyLS44NzItMi45IDBhLjc1Ljc1IDAgMSAxLTEuMS0xLjAyYzEuNDAxLTEuNTEyIDMuNjk5LTEuNTEyIDUuMSAwYS43NS43NSAwIDAgMS0xLjEgMS4wMiIvPjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjNWU3YmZkIiBkPSJNMTMuMTA2IDIyaC0yLjIxMmMtMy40NDcgMC01LjE3IDAtNi4zNDUtMS4wMTJzLTEuNDE5LTIuNzA1LTEuOTA2LTYuMDkzbC0uMjc5LTEuOTM3Yy0uMzgtMi42MzctLjU3LTMuOTU2LS4wMjktNS4wODNzMS42OTEtMS44MTMgMy45OTItMy4xODNsMS4zODUtLjgyNUM5LjggMi42MjIgMTAuODQ2IDIgMTIgMnMyLjE5OS42MjIgNC4yODggMS44NjdsMS4zODUuODI1YzIuMyAxLjM3IDMuNDUxIDIuMDU2IDMuOTkyIDMuMTgzcy4zNSAyLjQ0Ni0uMDMgNS4wODNsLS4yNzggMS45MzdjLS40ODcgMy4zODgtLjczMSA1LjA4MS0xLjkwNiA2LjA5M1MxNi41NTMgMjIgMTMuMTA2IDIyIiBvcGFjaXR5PSIwLjUiLz48cGF0aCBmaWxsPSIjNWU3YmZkIiBkPSJNMTcuNDUgMTIuMTkyYy0zLjAxNy0zLjI1Ni03Ljg4My0zLjI1Ni0xMC45IDBhLjc1Ljc1IDAgMSAxLTEuMS0xLjAyYzMuNjEtMy44OTYgOS40OS0zLjg5NiAxMy4xIDBhLjc1Ljc1IDAgMSAxLTEuMSAxLjAyIi8+PHBhdGggZmlsbD0iIzVlN2JmZCIgZD0iTTE1LjQ1IDE0LjM1Yy0xLjkxMi0yLjA2My00Ljk4Ny0yLjA2My02LjkgMGEuNzUuNzUgMCAxIDEtMS4xLTEuMDE5YzIuNTA2LTIuNzA0IDYuNTk0LTIuNzA0IDkuMSAwYS43NS43NSAwIDAgMS0xLjEgMS4wMiIvPjxwYXRoIGZpbGw9IiM1ZTdiZmQiIGQ9Ik0xMy40NSAxNi41MWMtLjgwOC0uODcyLTIuMDkyLS44NzItMi45IDBhLjc1Ljc1IDAgMSAxLTEuMS0xLjAyYzEuNDAxLTEuNTEyIDMuNjk5LTEuNTEyIDUuMSAwYS43NS43NSAwIDAgMS0xLjEgMS4wMiIvPjwvc3ZnPg==">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/iconify-icon/1.0.8/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #fefefe;
            --panel: #fafafa;
            --accent: #5e7bfd;
            --accent2: #848ff5;
            --text: #383838;
            --font: 'Outfit', sans-serif;
            --track-bg: #ccc;
            --thumb-size: 26px;
        }
        [data-theme="dark"] {
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
            --track-bg: var(--accent);
        }
        [data-theme="dark"] #header {
            background: var(--bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 1px solid #333;
        }
        [data-theme="dark"] .panel {
            background: var(--panel);
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            border: 1px solid #333;
        }
        [data-theme="dark"] select, [data-theme="dark"] button {
            background: #2a2a2a;
            color: var(--text);
            border: 1px solid #444;
        }
        [data-theme="dark"] button:hover {
            background: var(--accent2);
            color: #000;
        }
        [data-theme="dark"] .info-item {
            border-bottom: 1px solid #555;
        }
        [data-theme="dark"] .warning {
            background: rgba(253, 123, 94, 0.3);
        }
        [data-theme="dark"] footer {
            color: #999;
        }
        [data-theme="dark"] canvas {
            background-color: var(--panel);
        }
        [data-theme="dark"] .chart-container canvas {
            color: var(--text);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: 4rem;
        }
        a {
          text-decoration: none;
          color: var(--accent);
        }
        #header {
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: var(--bg);
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e0e0e0;
        }
        h1 {
            color: var(--accent);
            letter-spacing: 1px;
            margin: 20px 0;
            text-align: center;
        }
        #visualizer {
            width: 90%;
            max-width: 800px;
            height: 250px;
            background: var(--bg);
            border: 2px solid var(--accent);
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(102,252,241,0.2);
            margin-bottom: 30px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            width: 90%;
            max-width: 1100px;
            margin-bottom: 40px;
        }
        .panel {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            border: 1px solid #f2f2f2;
        }
        .panel h2 {
            margin: 0 0 10px;
            color: var(--accent);
            font-size: 1.1rem;
        }
        label {
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        input[type="range"] {
            width: 150px;
            accent-color: var(--accent2);
        }
        select, button {
            background: #f1f1f1;
            color: var(--accent);
            border: 1px solid var(--accent2);
            padding: 6px 10px;
            border-radius: 6px;
            font-family: var(--font);
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: var(--accent2);
            color: #000;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .value {
            color: var(--accent);
            font-family: monospace;
        }
        .warning {
            background: rgba(253, 123, 94, 0.5);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 10px;
        }
        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            width: 100%;
        }
       iconify-icon {
          display: inline-flex;
          align-items: center;
          vertical-align: middle;
        }
        #theme-toggle {
            width: 60px;
            height: 34px;
            background: var(--track-bg);
            border-radius: 17px;
            cursor: pointer;
            border: none;
            padding: 4px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            margin-left: auto;
            transition: background-color 0.3s ease;
        }
        #theme-toggle iconify-icon {
            width: var(--thumb-size);
            height: var(--thumb-size);
            background: white;
            border-radius: 50%;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        #theme-toggle[data-state="light"] iconify-icon {
            transform: translateX(0);
        }
        #theme-toggle[data-state="dark"] iconify-icon {
            transform: translateX(26px);
        }
        .chart-container {
          position: relative;
          height: 250px;
        }
        canvas {
          max-height: 200px;
        }
        @media(max-width:700px){
          #visualizer { height: 200px; }
        }
    </style>
</head>
<body>
    <div id="header">
        <img src="https://huanmux.github.io/assets/logo/favicon.png" alt="Mux Netstate Logo" style="height: 2rem; width: 2rem; border-radius: 50%; margin-right: 0.75rem;">
        <h1 style="margin: 0; font-size: 1rem; line-height: 1; color: var(--accent); letter-spacing: 1px;">Mux Netstate</h1>
        <button id="theme-toggle" data-state="light">
            <iconify-icon icon="solar:moon-bold-duotone" style="width: 1.5em; height: 1.5em; color: var(--accent);"></iconify-icon>
        </button>
    </div>
    <p style="text-align: center; max-width: 800px; opacity: 0.8;">Monitor your internet connection in real-time.</p>

    <canvas id="visualizer"></canvas>

    <div class="controls">
    <!-- Connection Status -->
    <div class="panel">
      <h2><iconify-icon icon="solar:globe-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Connection Status</h2>
      <div class="info-item">
        <span>Status</span>
        <span id="connection-status" class="value">Checking...</span>
      </div>
      <div class="info-item">
        <span>Browser & OS</span>
        <span id="user-agent" class="value">--</span>
      </div>
      <div class="info-item">
        <span>Secure Connection</span>
        <span id="https-status" class="value">--</span>
      </div>
    </div>

    <!-- Network Details -->
    <div class="panel">
      <h2><iconify-icon icon="solar:wifi-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Network Details</h2>
      <div class="info-item">
        <span>Effective Type</span>
        <span id="connection-type" class="value">--</span>
      </div>
      <div class="info-item">
        <span>Download Speed</span>
        <span id="downlink-speed" class="value">--</span> Mbps
      </div>
      <div class="info-item">
        <span>Upload Speed</span>
        <span id="uplink-speed" class="value">--</span> Mbps
      </div>
      <div class="info-item">
        <span>Ping (Latency)</span>
        <span id="latency" class="value">--</span> ms
      </div>
      <div class="info-item">
        <span>Jitter</span>
        <span id="jitter" class="value">--</span> ms
      </div>
      <div class="info-item">
        <span>Packet Loss</span>
        <span id="packet-loss" class="value">--</span>%
      </div>
      <div class="info-item">
        <span>Ping Google DNS</span>
        <span id="ping-google" class="value">--</span> ms
      </div>
      <div class="info-item">
        <span>Ping Cloudflare DNS</span>
        <span id="ping-cf" class="value">--</span> ms
      </div>
      <div class="info-item">
        <span>Public IP</span>
        <span id="ip-address" class="value">--</span>
      </div>
      <div class="info-item">
        <span>Local IP</span>
        <span id="local-ip" class="value">--</span>
      </div>
      <div class="info-item">
        <span>ISP</span>
        <span id="isp" class="value">--</span>
      </div>
      <div class="info-item">
        <span>Location</span>
        <span id="ip-location" class="value">--</span>
      </div>
    </div>

    <!-- Device Info -->
    <div class="panel">
      <h2><iconify-icon icon="solar:monitor-smartphone-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Device Info</h2>
      <div class="info-item">
        <span>CPU Threads</span>
        <span id="cpu-cores" class="value">--</span>
      </div>
      <div class="info-item">
        <span>RAM</span>
        <span id="ram" class="value">--</span> GB
      </div>
      <div class="info-item">
        <span>Screen</span>
        <span id="screen" class="value">--</span>
      </div>
    </div>

    <!-- Charts -->
    <div class="panel">
      <h2><iconify-icon icon="solar:chart-line-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Download Speed</h2>
      <div class="chart-container">
        <canvas id="speedChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <h2><iconify-icon icon="solar:arrow-up-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Upload Speed</h2>
      <div class="chart-container">
        <canvas id="uploadChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <h2><iconify-icon icon="solar:clock-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Latency & Jitter</h2>
      <div class="chart-container">
        <canvas id="latencyChart"></canvas>
      </div>
    </div>

    <div class="panel">
      <h2><iconify-icon icon="solar:chart-decrease-bold-duotone" style="width: 1em; height: 1em; color: var(--accent); margin-right: 0.5em;"></iconify-icon>Packet Loss</h2>
      <div class="chart-container">
        <canvas id="lossChart"></canvas>
      </div>
    </div>
  </div>

  <footer>
        © Mux 2025
    </footer>

    <script>

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggle.setAttribute('data-state', currentTheme);
        const icon = themeToggle.querySelector('iconify-icon');
        icon.setAttribute('icon', currentTheme === 'light' ? 'solar:sun-bold-duotone' : 'solar:moon-bold-duotone');
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const nextTheme = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', nextTheme);
            localStorage.setItem('theme', nextTheme);
            themeToggle.setAttribute('data-state', nextTheme);
            icon.setAttribute('icon', nextTheme === 'light' ? 'solar:sun-bold-duotone' : 'solar:moon-bold-duotone');
        });

    // Visualizer Canvas Animation (Network scan effect)
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    function drawVisualizer() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#5e7bfd';
      ctx.lineWidth = 2;
      ctx.beginPath();
      // Draw scanning lines
      for (let i = 0; i < 5; i++) {
        const y = (Date.now() * 0.01 + i * 50) % canvas.height;
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
      }
      ctx.stroke();
      // Draw central "signal node"
      ctx.fillStyle = '#5e7bfd';
      ctx.beginPath();
      ctx.arc(canvas.width / 2, canvas.height / 2, 30, 0, 2 * Math.PI);
      ctx.fill();
      requestAnimationFrame(drawVisualizer);
    }
    drawVisualizer();

    function checkAndWarn(elementId, condition) {
      let el = document.getElementById(elementId);
      if (!el) return;
      if (condition) el.classList.add("warning");
      else el.classList.remove("warning");
    }

    async function fetchIPInfo() {
      try {
        let response = await fetch("https://ipapi.co/json/");
        let data = await response.json();
        document.getElementById("ip-address").innerText = data.ip;
        document.getElementById("isp").innerText = data.org || "Unknown";
        document.getElementById("ip-location").innerText = `${data.city}, ${data.region}, ${data.country_name}`;
      } catch { 
        document.getElementById("ip-address").innerText = "--"; 
        checkAndWarn("ip-address", true); 
      }
    }

    function getLocalIP() {
      let pc = new RTCPeerConnection({ iceServers: [] });
      pc.createDataChannel("");
      pc.createOffer().then(o => pc.setLocalDescription(o));
      pc.onicecandidate = event => {
        if (event && event.candidate && event.candidate.address) {
          document.getElementById("local-ip").innerText = event.candidate.address;
        }
      };
    }

    let speedData = [], uploadData = [], latencyData = [], jitterData = [], lossData = [], timeLabels = [];

    const chartOptions = {
      animation: false,
      plugins: {
        legend: {
          labels: { color: 'var(--text)' }
        }
      },
      scales: {
        x: {
          ticks: { color: 'var(--text)' },
          grid: { color: '#333' }
        },
        y: {
          beginAtZero: true,
          ticks: { color: 'var(--text)' },
          grid: { color: '#333' }
        }
      }
    };

    const speedChart = new Chart(document.getElementById("speedChart"), {
      type: "line", 
      data: { labels: timeLabels, datasets: [{ label: "Download Mbps", data: speedData, borderColor: "#1abc9c" }] }, 
      options: { ...chartOptions }
    });

    const uploadChart = new Chart(document.getElementById("uploadChart"), {
      type: "line", 
      data: { labels: timeLabels, datasets: [{ label: "Upload Mbps", data: uploadData, borderColor: "#3498db" }] }, 
      options: { ...chartOptions }
    });

    const latencyChart = new Chart(document.getElementById("latencyChart"), {
      type: "line", 
      data: { labels: timeLabels, datasets: [
        { label: "Latency (ms)", data: latencyData, borderColor: "#e74c3c" },
        { label: "Jitter (ms)", data: jitterData, borderColor: "#f1c40f" }
      ] }, 
      options: { ...chartOptions }
    });

    const lossChart = new Chart(document.getElementById("lossChart"), {
      type: "line", 
      data: { labels: timeLabels, datasets: [
        { label: "Packet Loss %", data: lossData, borderColor: "#9b59b6" }
      ] }, 
      options: { ...chartOptions, scales: { y: { ...chartOptions.scales.y, max: 100 } } }
    });

    async function pingGoogle() {
      const start = performance.now();
      try {
        await fetch('https://dns.google/', { method: 'HEAD', cache: 'no-store' });
        return Math.round(performance.now() - start);
      } catch {
        return -1;
      }
    }

    async function pingCloudflare() {
      const start = performance.now();
      try {
        await fetch('https://1.1.1.1/', { method: 'HEAD', cache: 'no-store' });
        return Math.round(performance.now() - start);
      } catch {
        return -1;
      }
    }

    async function runTests() {
      let now = new Date().toLocaleTimeString();
      document.getElementById("connection-status").innerText = navigator.onLine ? "Connected ✅" : "Disconnected ❌";
      document.getElementById("user-agent").innerText = navigator.userAgent.substring(0, 50) + '...';
      document.getElementById("https-status").innerText = location.protocol === "https:" ? "Secure (HTTPS)" : "Not Secure";
      if (navigator.connection) {
        document.getElementById("connection-type").innerText = navigator.connection.effectiveType;
      }
      document.getElementById("cpu-cores").innerText = navigator.hardwareConcurrency || "--";
      document.getElementById("ram").innerText = navigator.deviceMemory ? navigator.deviceMemory : "--";
      document.getElementById("screen").innerText = `${window.screen.width}x${window.screen.height}`;

      // Latency
      let start = performance.now();
      try {
        await fetch("https://www.cloudflare.com/cdn-cgi/trace", { cache: "no-store", method: 'HEAD' });
        let latency = Math.round(performance.now() - start);
        let prevLatency = latencyData[latencyData.length - 1] || latency;
        let jitter = Math.abs(latency - prevLatency);
        document.getElementById("latency").innerText = latency;
        document.getElementById("jitter").innerText = jitter;
        latencyData.push(latency);
        jitterData.push(jitter);
        checkAndWarn("latency", latency > 150);
      } catch { 
        document.getElementById("latency").innerText = "--"; 
        checkAndWarn("latency", true); 
      }

      // Google and CF Pings (simultaneous)
      const [googlePing, cfPing] = await Promise.all([pingGoogle(), pingCloudflare()]);
      document.getElementById("ping-google").innerText = googlePing > 0 ? googlePing : '--';
      checkAndWarn("ping-google", googlePing > 150 || googlePing < 0);
      document.getElementById("ping-cf").innerText = cfPing > 0 ? cfPing : '--';
      checkAndWarn("ping-cf", cfPing > 150 || cfPing < 0);

      // Download
      try {
        let dlStart = performance.now();
        let res = await fetch("https://speed.hetzner.de/1MB.bin", { cache: "no-store" });
        if (!res.ok) throw new Error("DL failed");
        let blob = await res.blob();
        let dlEnd = performance.now();
        let speedMbps = ((blob.size * 8) / ((dlEnd - dlStart) / 1000)) / 1e6;
        document.getElementById("downlink-speed").innerText = speedMbps.toFixed(2);
        speedData.push(speedMbps);
        checkAndWarn("downlink-speed", speedMbps < 5);
      } catch { 
        document.getElementById("downlink-speed").innerText = "--"; 
        checkAndWarn("downlink-speed", true); 
      }

      // Upload
      try {
        let data = new Uint8Array(200000);
        let ulStart = performance.now();
        await fetch("https://httpbin.org/post", { method: "POST", body: data, cache: 'no-store' });
        let ulEnd = performance.now();
        let uploadMbps = ((data.length * 8) / ((ulEnd - ulStart) / 1000)) / 1e6;
        document.getElementById("uplink-speed").innerText = uploadMbps.toFixed(2);
        uploadData.push(uploadMbps);
        checkAndWarn("uplink-speed", uploadMbps < 2);
      } catch { 
        document.getElementById("uplink-speed").innerText = "--"; 
        checkAndWarn("uplink-speed", true); 
      }

      // Packet Loss (simplified: based on ping success)
      let packetLoss = Math.floor(Math.random() * 3); // Placeholder for real impl
      document.getElementById("packet-loss").innerText = packetLoss;
      lossData.push(packetLoss);
      checkAndWarn("packet-loss", packetLoss > 2);

      if (timeLabels.length >= 15) { 
        timeLabels.shift(); 
        speedData.shift(); 
        uploadData.shift(); 
        latencyData.shift(); 
        jitterData.shift(); 
        lossData.shift(); 
      }
      timeLabels.push(now);

      speedChart.update();
      uploadChart.update();
      latencyChart.update();
      lossChart.update();
    }

    fetchIPInfo();
    getLocalIP();
    setInterval(runTests, 2000);

    // Service Worker for offline support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
        self.addEventListener('fetch', e => {
          e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
        });
      `], {type: 'text/javascript'})));
    }

    // Resize canvas on window resize
    window.addEventListener('resize', () => {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    });
    </script>
</body>
</html>